let konradMessages=[],sessionData=null,isLocalStorageDirty=!1;function initializeLocalStorageCache(){try{const e=localStorage.getItem("konradChatHistory");if(e){const t=JSON.parse(e);if(Array.isArray(t)){konradMessages=t.filter(e=>e&&"string"==typeof e.content&&"string"==typeof e.type&&"number"==typeof e.timestamp&&e.content.length<5e3);const e=Date.now()-18e5;konradMessages=konradMessages.filter(t=>t.timestamp>e),konradMessages.length>10&&(konradMessages=konradMessages.slice(-10))}}const t=localStorage.getItem("KonradChatSession");sessionData=t?JSON.parse(t):{messageCount:0,timestamp:Date.now()}}catch(e){console.warn("Error initializing localStorage cache:",e),konradMessages=[],sessionData={messageCount:0,timestamp:Date.now()}}}function batchWriteToLocalStorage(){if(isLocalStorageDirty)try{localStorage.setItem("konradChatHistory",JSON.stringify(konradMessages)),localStorage.setItem("KonradChatSession",JSON.stringify(sessionData)),isLocalStorageDirty=!1}catch(e){console.warn("Could not batch write to localStorage:",e)}}function markLocalStorageDirty(){isLocalStorageDirty=!0}function loadChatHistory(){}function saveChatHistory(){markLocalStorageDirty()}function resetChat(){konradMessages=[],isLocalStorageDirty=!0,batchWriteToLocalStorage();const e=document.getElementById("konrad-chat-messages");e&&(e.innerHTML="")}function scrollToBottom(e,t=!0){e&&requestAnimationFrame(()=>{t?e.scrollTo({top:e.scrollHeight,behavior:"smooth"}):e.scrollTop=e.scrollHeight})}function addKonradMessage(e,t="user"){const a={content:e,type:t,timestamp:Date.now()};konradMessages.push(a),"user"===t?renderUserMessage(e):renderKonradMessage(e),markLocalStorageDirty(),konradMessages.length>15&&(konradMessages=konradMessages.slice(-10))}function renderUserMessage(e){const t=document.getElementById("konrad-chat-messages");if(t){const a=document.createElement("div");a.className="user-message";const n=document.createElement("div");n.className="user-message-content",n.textContent=String(e).trim();const s=document.createElement("div");s.className="user-message-avatar-wrapper";const o=document.createElement("div");o.className="user-message-avatar";const r=document.createElement("div");r.className="user-icon",r.innerHTML="ðŸ‘¤",o.appendChild(r),s.appendChild(o),a.appendChild(n),a.appendChild(s),t.appendChild(a),scrollToBottom(t,!0)}}function renderKonradMessage(e){const t=document.getElementById("konrad-chat-messages");if(t){const a=document.createElement("div");a.className="konrad-message";const n=document.createElement("div");n.className="konrad-message-avatar-wrapper";const s=document.createElement("img");s.src="/konrad-logo.webp",s.alt="Konrad",s.className="konrad-message-avatar";const o=document.createElement("span");o.className="konrad-message-status-dot",n.appendChild(s),n.appendChild(o);const r=document.createElement("div");r.className="konrad-message-content",r.textContent=String(e).trim(),a.appendChild(n),a.appendChild(r),t.appendChild(a);const i=1===t.querySelectorAll(".konrad-message, .user-message").length;window.KonradFeedback&&!i&&window.KonradFeedback.attachFeedbackTo(a),scrollToBottom(t,!0)}}function showTypingIndicator(){if(document.getElementById("konrad-typing"))return;const e=document.getElementById("konrad-chat-messages");if(!e)return;const t=document.createElement("div");t.id="konrad-typing",t.className="konrad-typing";const a=document.createElement("div");a.className="konrad-message-avatar-wrapper";const n=document.createElement("img");n.src="/konrad-logo.webp",n.alt="Konrad",n.className="konrad-message-avatar";const s=document.createElement("span");s.className="konrad-message-status-dot",a.appendChild(n),a.appendChild(s);const o=document.createElement("div");o.className="konrad-typing-content";const r=document.createElement("div");r.className="konrad-typing-dots";for(let e=0;e<3;e++){const e=document.createElement("div");e.className="konrad-typing-dot",r.appendChild(e)}o.appendChild(r),t.appendChild(a),t.appendChild(o),e.appendChild(t),scrollToBottom(e,!0)}function hideTypingIndicator(){const e=document.getElementById("konrad-typing");e&&e.remove()}function checkMessageLimit(){try{const e=Date.now(),t=864e5;if(!sessionData)return sessionData={messageCount:0,timestamp:e},markLocalStorageDirty(),sessionData;return e-sessionData.timestamp>t&&(sessionData={messageCount:0,timestamp:e},markLocalStorageDirty()),sessionData}catch(e){return console.warn("Error checking message limit:",e),sessionData={messageCount:0,timestamp:Date.now()},markLocalStorageDirty(),sessionData}}function updateMessageCount(){try{checkMessageLimit().messageCount+=1,markLocalStorageDirty()}catch(e){console.warn("Error updating message count:",e)}}function hasContactInfo(e){if(!e||"string"!=typeof e)return!1;e.toLowerCase();const t=[/(?:jag heter|mitt namn Ã¤r|namnet Ã¤r|kallas|hej mitt namn|hej jag heter)\s+([a-zA-ZÃ¥Ã¤Ã¶Ã…Ã„Ã–\-\s]{2,})/i,/^([a-zA-ZÃ¥Ã¤Ã¶Ã…Ã„Ã–\-\s]{2,})\s*(?:hÃ¤r|heter jag|Ã¤r mitt namn)/i];for(let a of t)if(a.test(e))return!0;if(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/.test(e))return!0;const a=[/(?:\+46|0)\s?7[\d\s\-()]{7,}/,/(?:\+46|0)\s?[1-9]\d{1,2}[\s\-]?\d{6,8}/,/07\d[\s\-]?\d{3}[\s\-]?\d{3}/,/\b\d{10}\b/,/\b\d{3}[\s\-]\d{3}[\s\-]\d{4}\b/];for(let t of a)if(t.test(e))return!0;return!1}async function sendKonradMessage(){const e=document.getElementById("konrad-input"),t=e.value.trim();if(!t)return;if(t.length>2e3)return void(window.Utils&&window.Utils.showFormMessage("Meddelandet Ã¤r fÃ¶r lÃ¥ngt. Max 2000 tecken.","error"));const a=t.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"").replace(/javascript:/gi,"").replace(/on\w+\s*=/gi,"");if(!a)return;if(checkMessageLimit().messageCount>=15){if(!hasContactInfo(a))return addKonradMessage(a,"user"),e.value="",e.style.height="auto",showTypingIndicator(),void setTimeout(()=>{hideTypingIndicator();addKonradMessage("Du har nÃ¥tt maxgrÃ¤nsen fÃ¶r idag ðŸ˜Š Vill du att vi hÃ¶r av oss? LÃ¤mna gÃ¤rna namn & nummer â€“ det kostar inget att testa!","ai"),batchWriteToLocalStorage()},800)}addKonradMessage(a,"user"),e.value="",e.style.height="auto",updateMessageCount(),batchWriteToLocalStorage(),showTypingIndicator();try{const e=new AbortController,t=setTimeout(()=>e.abort(),3e4);if(!window.API_BASE_URL)throw console.error("API_BASE_URL not configured!"),new Error("API configuration missing");const n=await fetch(`${window.API_BASE_URL}/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:a}),signal:e.signal});if(clearTimeout(t),!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const s=await n.json();setTimeout(()=>{hideTypingIndicator();let e="TyvÃ¤rr kunde jag inte svara just nu. FÃ¶rsÃ¶k igen!";s.response&&"string"==typeof s.response&&s.response.trim().length>0&&(e=s.response.length>5e3?s.response.substring(0,5e3)+"...":s.response),addKonradMessage(e,"ai"),batchWriteToLocalStorage()},800)}catch(e){console.error("Error sending message to Konrad:",e),console.error("Error details:",{name:e.name,message:e.message,stack:e.stack}),setTimeout(()=>{hideTypingIndicator();let t="TyvÃ¤rr, nÃ¥got gick fel. FÃ¶rsÃ¶k igen eller kontakta oss direkt.";navigator.onLine?"AbortError"===e.name?t="FÃ¶rfrÃ¥gan tog fÃ¶r lÃ¥ng tid. FÃ¶rsÃ¶k igen.":e.message.includes("Failed to fetch")&&(t="Kan inte nÃ¥ servern just nu. Backend-tjÃ¤nsten kanske Ã¤r nere. FÃ¶rsÃ¶k igen om en stund eller kontakta oss pÃ¥ kontakt@aihjalpen.se"):t="Du verkar vara offline just nu. Kontrollera din internetanslutning och fÃ¶rsÃ¶k igen.",addKonradMessage(t,"ai"),batchWriteToLocalStorage()},500)}}function openKonradModal(e){e&&e.preventDefault();const t=document.getElementById("konrad-modal");if(!t)return;if(t.classList.contains("active"))return;t.classList.remove("hidden"),t.classList.add("active"),t.setAttribute("aria-hidden","false"),document.body.classList.add("modal-open"),window._previousFocus=document.activeElement;const a=document.getElementById("konrad-chat-messages");a&&(a.innerHTML=""),resetChat(),addKonradMessage("Hej! Jag Ã¤r Konrad â€“ din digitala guide pÃ¥ AI-hjÃ¤lpen. Jag hjÃ¤lper fÃ¶retag att fÃ¶rstÃ¥ och anvÃ¤nda AI utan stress eller krÃ¥ngel. Som din mentor hÃ¤r kan jag vÃ¤gleda dig genom vÃ¥ra lÃ¶sningar och svara pÃ¥ alla frÃ¥gor du har. Vad kan jag hjÃ¤lpa dig med idag?","ai"),requestAnimationFrame(()=>{const e=document.getElementById("konrad-input");e&&(e.focus(),e.addEventListener("keydown",function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),sendKonradMessage())}),e.addEventListener("input",function(){this.style.height="auto";const e=Math.min(this.scrollHeight,96);this.style.height=e+"px",this.style.overflowY=this.scrollHeight>96?"auto":"hidden"}))}),t._escListener||(t._escListener=e=>{"Escape"===e.key&&closeKonradModal()},document.addEventListener("keydown",t._escListener))}function closeKonradModal(){const e=document.getElementById("konrad-modal");e&&e.classList.contains("active")&&(e.classList.add("hidden"),e.classList.remove("active"),e.setAttribute("aria-hidden","true"),document.body.classList.remove("modal-open"),e._escListener&&(document.removeEventListener("keydown",e._escListener),e._escListener=null),window._previousFocus&&"function"==typeof window._previousFocus.focus&&requestAnimationFrame(()=>{window._previousFocus.focus(),window._previousFocus=null}),resetChat())}function initChat(){initializeLocalStorageCache()}function clearTestHistory(){konradMessages=[],markLocalStorageDirty(),batchWriteToLocalStorage();const e=document.getElementById("konrad-chat-messages");e&&(e.innerHTML="")}window.addEventListener("aih:beforeunload",function(){batchWriteToLocalStorage()}),window.sendKonradMessage=sendKonradMessage,window.resetChat=resetChat,window.showTypingIndicator=showTypingIndicator,window.hideTypingIndicator=hideTypingIndicator,window.openKonradModal=openKonradModal,window.closeKonradModal=closeKonradModal,window.clearTestHistory=clearTestHistory,window.Chat={initChat:initChat,openKonradModal:openKonradModal,closeKonradModal:closeKonradModal,sendKonradMessage:sendKonradMessage},window.openKonradModal=openKonradModal,window.closeKonradModal=closeKonradModal,window.sendKonradMessage=sendKonradMessage;