let gdprAccepted=null,gdprAcceptedDate=null,cookieConsent=null,isGdprLocalStorageDirty=!1;function initializeGdprLocalStorageCache(){try{gdprAccepted=localStorage.getItem("gdpr-accepted"),gdprAcceptedDate=localStorage.getItem("gdpr-accepted-date");const e=localStorage.getItem("ai-hjalpen-cookie-consent");e&&(cookieConsent=JSON.parse(e))}catch(e){console.warn("Error initializing GDPR localStorage cache:",e),gdprAccepted=null,gdprAcceptedDate=null,cookieConsent=null}}function batchWriteGdprToLocalStorage(){if(isGdprLocalStorageDirty)try{null!==gdprAccepted&&localStorage.setItem("gdpr-accepted",gdprAccepted),null!==gdprAcceptedDate&&localStorage.setItem("gdpr-accepted-date",gdprAcceptedDate),null!==cookieConsent&&localStorage.setItem("ai-hjalpen-cookie-consent",JSON.stringify(cookieConsent)),isGdprLocalStorageDirty=!1}catch(e){console.warn("Could not batch write GDPR data to localStorage:",e)}}function markGdprLocalStorageDirty(){isGdprLocalStorageDirty=!0}function updateAnalyticsConsent(e){window.gtag&&window.dataLayer&&window.gtag("consent","update",{analytics_storage:e?"granted":"denied"})}function openGdprModal(){const e=document.getElementById("gdpr-popup");e?e.classList.contains("gdpr-popup-visible")||(e.classList.add("gdpr-popup-visible"),e.setAttribute("aria-hidden","false"),document.body.classList.add("modal-open"),window._gdprPreviousFocus=document.activeElement,requestAnimationFrame(()=>{const t=e.querySelector("button, a");t&&t.focus()}),e._escListener||(e._escListener=e=>{"Escape"===e.key&&closeGdprModal()},document.addEventListener("keydown",e._escListener))):window.open("/integritetspolicy.html","_blank","noopener")}function closeGdprModal(){const e=document.getElementById("gdpr-popup");e&&e.classList.contains("gdpr-popup-visible")&&(e.classList.remove("gdpr-popup-visible"),e.setAttribute("aria-hidden","true"),document.body.classList.remove("modal-open"),e._escListener&&(document.removeEventListener("keydown",e._escListener),e._escListener=null),window._gdprPreviousFocus&&"function"==typeof window._gdprPreviousFocus.focus&&requestAnimationFrame(()=>{window._gdprPreviousFocus.focus(),window._gdprPreviousFocus=null}))}function initGdprPopup(){const e=document.getElementById("gdpr-popup");if(!e)return;initializeGdprLocalStorageCache();const t=document.getElementById("gdpr-accept");t?(gdprAccepted||setTimeout(()=>{e.style.display="flex",requestAnimationFrame(()=>{e.classList.add("active")})},1e3),t.addEventListener("click",function(){gdprAccepted="true",gdprAcceptedDate=(new Date).toISOString(),markGdprLocalStorageDirty();try{localStorage.setItem("gdprConsent",JSON.stringify({necessary:!0,analytics:!1,timestamp:Date.now()}))}catch(e){console.warn("Could not save gdprConsent:",e)}e.classList.remove("gdpr-popup-visible"),setTimeout(()=>{e.style.display="none",batchWriteGdprToLocalStorage()},300)})):console.warn("GDPR accept button not found")}function initCookieConsent(){const e=document.getElementById("cookie-banner"),t=document.getElementById("cookie-settings-btn"),o=document.getElementById("cookie-accept-all"),n=document.getElementById("cookie-reject-all"),i=document.getElementById("cookie-save-settings"),c=document.getElementById("cookie-analytics");function r(e,t){cookieConsent={necessary:e,analytics:t,timestamp:Date.now()},markGdprLocalStorageDirty(),updateAnalyticsConsent(t)}function d(){return cookieConsent}function s(){e&&(e.classList.add("cookie-banner-visible"),document.body.style.paddingBottom="0")}function a(){e&&e.classList.remove("cookie-banner-visible"),batchWriteGdprToLocalStorage()}o&&o.addEventListener("click",function(){r(!0,!0),c&&(c.checked=!0),a()}),n&&n.addEventListener("click",function(){r(!0,!1),c&&(c.checked=!1),a()}),i&&c&&i.addEventListener("click",function(){r(!0,c.checked),a()}),t&&t.addEventListener("click",function(){const e=d();e&&c&&(c.checked=e.analytics),s()}),function(){const e=d();e?(c&&(c.checked=e.analytics),a(),!0===e.analytics?updateAnalyticsConsent(!0):updateAnalyticsConsent(!1)):s()}()}function initFormHandler(){const e=document.querySelector(".contact-form");e&&e.addEventListener("submit",async function(t){t.preventDefault();const o=new FormData(e),n=Object.fromEntries(o.entries());if(!n.name||n.name.length<2)return void(window.Utils&&window.Utils.showFormMessage("Företagsnamn måste vara minst 2 tecken","error"));if(!n.email||!n.email.includes("@"))return void(window.Utils&&window.Utils.showFormMessage("Ange en giltig e-postadress","error"));if(!n.message||n.message.length<10)return void(window.Utils&&window.Utils.showFormMessage("Meddelandet måste vara minst 10 tecken","error"));const i=e.querySelector('button[type="submit"]'),c=i.textContent;i.textContent="Skickar...",i.disabled=!0;try{await new Promise(e=>setTimeout(e,1e3)),window.Utils&&window.Utils.showFormMessage("Tack! Vi återkommer inom 24 timmar.","success"),e.reset()}catch(e){console.error("Error submitting form:",e),window.Utils&&window.Utils.showFormMessage("Ett fel uppstod. Försök igen eller kontakta oss direkt.","error")}finally{i.textContent=c,i.disabled=!1}})}function showIfNeeded(){try{if(!localStorage.getItem("gdprConsent")){const e=document.getElementById("gdpr-popup");e&&(e.style.display="flex",setTimeout(()=>{e.classList.add("gdpr-popup-visible")},100))}}catch(e){console.warn("Error checking GDPR consent:",e)}}function wireUp(){initGdprPopup(),initCookieConsent(),initFormHandler(),showIfNeeded()}function waitForEl(e,t,o){return window.Utils&&"function"==typeof window.Utils.waitForEl?window.Utils.waitForEl(e,t,o):Promise.resolve(document.querySelector(e))}window.addEventListener("aih:beforeunload",function(){batchWriteGdprToLocalStorage()}),window.openGdprModal=openGdprModal,window.closeGdprModal=closeGdprModal,window.GDPR={initGdprPopup:initGdprPopup,initCookieConsent:initCookieConsent,initFormHandler:initFormHandler,openGdprModal:openGdprModal,closeGdprModal:closeGdprModal,wireUp:wireUp,showIfNeeded:showIfNeeded},function(){let e=!1;async function t(){if(!e)try{const e=await waitForEl("#gdpr-popup").catch(()=>null),t=await waitForEl("#cookie-banner").catch(()=>null);if(!e||!t){const e=new MutationObserver((e,t)=>{const n=document.querySelector("#gdpr-popup"),i=document.querySelector("#cookie-banner");n&&i&&(t.disconnect(),o(n,i))});return e.observe(document.documentElement,{childList:!0,subtree:!0}),void setTimeout(()=>{e.disconnect()},1e4)}o(e,t)}catch(e){}}function o(t,o){e||window.__AIH_GDPR_INIT__||(e=!0,window.__AIH_GDPR_INIT__=!0,initGdprPopup(),initCookieConsent(),initFormHandler())}document.addEventListener("DOMContentLoaded",t),document.addEventListener("gdprElementsLoaded",t,{once:!0}),document.addEventListener("gdprElementsLoaded",function(){setTimeout(showIfNeeded,200)},{once:!0})}();